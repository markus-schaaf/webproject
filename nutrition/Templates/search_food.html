<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lebensmittel Suche</title>
</head>
<body>
    <h1>Lebensmittel suchen</h1>
    <form id="search-form">
        <input type="text" id="search-input" placeholder="Lebensmittel eingeben" required>
        <button type="button" onclick="searchFood()">Suchen</button>
    </form>

    <!-- Dropdown und Weiter-Button -->
    <div id="dropdown-container" style="display: none;">
        <label for="dropdown">Wähle ein Lebensmittel:</label>
        <select id="dropdown">
            <option value="">Bitte auswählen</option>
        </select>
        <button id="next-button" style="display: none;" onclick="loadSelectedFoodDetails()">Weiter</button>
    </div>

    <!-- Details werden hier angezeigt -->
    <div id="food-details"></div>

    <!-- Bereich für Recently Used-->
    <!-- Dropdown für zuletzt genutzte Einheiten mit Button -->
    <div>
        <label for="recent-units-dropdown">Zuletzt genutzte Einheiten:</label>
        <select id="recent-units-dropdown">
            <option value="">Bitte auswählen</option>
        </select>
        <button id="recent-unit-details-btn" onclick="loadRecentUnitDetails()">Details anzeigen</button>
    </div>

    <!-- Bereich für die Anzeige der Details -->
    <div id="recent-unit-details"></div>


    <script>
        // Funktion: API-Suche nach Lebensmitteln
        async function searchFood() {
            const query = document.getElementById('search-input').value;
            const response = await fetch(`/nutrition/search_food/?query=${query}`);
            const data = await response.json();
            const dropdown = document.getElementById('dropdown');
            const container = document.getElementById('dropdown-container');
            const nextButton = document.getElementById('next-button');

            if (data.results.length > 0) {
                // Dropdown mit Optionen füllen
                dropdown.innerHTML = '<option value="">Bitte auswählen</option>';
                data.results.forEach(item => {
                    dropdown.innerHTML += `<option value="${item.code}">${item.name}</option>`;
                });
                container.style.display = 'block';
                nextButton.style.display = 'inline-block'; // "Weiter"-Button anzeigen
            } else {
                alert('Keine Ergebnisse gefunden.');
                container.style.display = 'none';
            }
        }

        // Funktion: Details für ausgewähltes Lebensmittel laden
        async function loadSelectedFoodDetails() {
            const dropdown = document.getElementById('dropdown');
            const selectedCode = dropdown.value;

            if (!selectedCode) {
                alert('Bitte wähle ein Lebensmittel aus.');
                return;
            }

            const response = await fetch(`/nutrition/food-details/?code=${selectedCode}`);
            const data = await response.json();

            console.log("API Response:", data); // Debugging
            
            const details = document.getElementById('food-details');

            if (data.success) {
                // Details anzeigen
                details.innerHTML = `
                    <h2>Details</h2>
                    <p>Name: ${data.name}</p>
                    <p>Kalorien: ${data.calories} kcal/100g</p>
                    <p>Proteine: ${data.protein} g/100g</p>
                    <p>Kohlenhydrate: ${data.carbohydrates} g/100g</p>
                    <p>Fette: ${data.fat} g/100g</p>
                `;
            } else {
                details.innerHTML = '<p>Details konnten nicht geladen werden.</p>';
            }
        }

        // Funktion: Zuletzt genutzte Einheiten laden
        async function loadRecentUnits() {
            const response = await fetch('/nutrition/recent-units/');
            const data = await response.json();

            const dropdown = document.getElementById('recent-units-dropdown');
            dropdown.innerHTML = '<option value="">Bitte auswählen</option>'; // Reset

            if (data.results.length > 0) {
                data.results.forEach(item => {
                    dropdown.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } else {
                alert('Keine zuletzt genutzten Einheiten gefunden.');
            }
        }

        // Rufe die Funktion beim Laden der Seite auf
        document.addEventListener('DOMContentLoaded', loadRecentUnits);


        // Funktion: Details für die ausgewählte zuletzt genutzte Einheit laden
        async function loadRecentUnitDetails() {
            const dropdown = document.getElementById('recent-units-dropdown');
            const selectedId = dropdown.value;

            if (!selectedId) {
                alert('Bitte wähle eine Einheit aus.');
                return;
            }

            // API-Aufruf
            const response = await fetch(`/nutrition/food-unit-details/?id=${selectedId}`);
            const data = await response.json();

            const detailsDiv = document.getElementById('recent-unit-details');

            if (data.success) {
                // Details anzeigen
                detailsDiv.innerHTML = `
                    <h2>Details der Einheit</h2>
                    <p>Name: ${data.name}</p>
                    <p>Kalorien: ${data.calories} kcal</p>
                    <p>Kohlenhydrate: ${data.carbohydrates} g</p>
                    <p>Fette: ${data.fat} g</p>
                    <p>Proteine: ${data.protein} g</p>
                    <p>Datum: ${data.time_eaten}</p>
                `;
            } else {
                detailsDiv.innerHTML = '<p>Details konnten nicht geladen werden.</p>';
            }
        }
    </script>
</body>
</html>
